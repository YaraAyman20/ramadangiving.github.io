# Comprehensive CI/CD workflow for Next.js static site
# Consolidates: build, deploy, quality checks, Lighthouse, and image optimization
name: Build, Test & Deploy

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write

concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  NODE_VERSION: '20'

jobs:
  # ===========================================
  # Code Quality & Type Checking
  # ===========================================
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ” Lint code
        run: npm run lint

      - name: ğŸ” Type check
        run: npx tsc --noEmit

  # ===========================================
  # Build & Optimize
  # ===========================================
  build:
    name: Build & Optimize
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“‹ Setup Pages
        uses: actions/configure-pages@v5
        with:
          static_site_generator: next

      - name: ğŸ—„ï¸ Restore Next.js cache
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx', '**/*.md') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ“ Generate blog posts
        run: npm run posts

      - name: ğŸ–¼ï¸ Analyze images
        run: |
          echo "## ğŸ–¼ï¸ Image Analysis" >> $GITHUB_STEP_SUMMARY
          node scripts/optimize-images.js >> $GITHUB_STEP_SUMMARY || true

      - name: ğŸ—ï¸ Build Next.js application
        run: npm run build
        env:
          NODE_ENV: production

      - name: ğŸ“Š Build summary
        run: |
          echo "## ğŸ“¦ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          
          TOTAL_SIZE=$(du -sh out 2>/dev/null | cut -f1 || echo "N/A")
          HTML_COUNT=$(find out -name "*.html" 2>/dev/null | wc -l || echo "0")
          JS_SIZE=$(find out -name "*.js" -exec du -ch {} + 2>/dev/null | tail -1 | cut -f1 || echo "0")
          CSS_SIZE=$(find out -name "*.css" -exec du -ch {} + 2>/dev/null | tail -1 | cut -f1 || echo "0")
          
          echo "| Total Size | $TOTAL_SIZE |" >> $GITHUB_STEP_SUMMARY
          echo "| HTML Pages | $HTML_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| JavaScript | $JS_SIZE |" >> $GITHUB_STEP_SUMMARY
          echo "| CSS | $CSS_SIZE |" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“¤ Upload build artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./out

  # ===========================================
  # Lighthouse Performance Audit
  # ===========================================
  lighthouse:
    name: Lighthouse Audit
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: github-pages
          path: ./out-artifact

      - name: ğŸ“¦ Extract artifact
        run: |
          mkdir -p out
          if [ -f out-artifact/artifact.tar ]; then
            tar -xvf out-artifact/artifact.tar -C out
          else
            cp -r out-artifact/* out/ 2>/dev/null || true
          fi

      - name: ğŸ”¦ Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v11
        with:
          configPath: './.lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true
        continue-on-error: true

      - name: ğŸ“Š Upload Lighthouse reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-reports
          path: '.lighthouseci'
          retention-days: 30

  # ===========================================
  # Image Optimization (PRs only)
  # ===========================================
  optimize-images:
    name: Optimize Images
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' &&
      contains(github.event.pull_request.changed_files, 'public/assets')
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ–¼ï¸ Analyze images
        run: |
          echo "## ğŸ–¼ï¸ Image Analysis" >> $GITHUB_STEP_SUMMARY
          node scripts/optimize-images.js >> $GITHUB_STEP_SUMMARY || true

      - name: ğŸ”§ Optimize images (if Sharp available)
        run: |
          if npm list sharp >/dev/null 2>&1; then
            node scripts/optimize-images-auto.js || true
          else
            echo "âš ï¸ Sharp not installed. Skipping auto-optimization."
          fi
        continue-on-error: true

      - name: ğŸ“¤ Commit optimized images
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'ğŸ–¼ï¸ Auto-optimize images'
          file_pattern: 'public/assets/**/*'
        continue-on-error: true

  # ===========================================
  # Content Validation
  # ===========================================
  content-check:
    name: Content Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ“ Validate blog posts
        run: |
          echo "## ğŸ“ Blog Posts" >> $GITHUB_STEP_SUMMARY
          npm run posts
          
          POST_COUNT=$(find content/posts -name "*.md" ! -name "_*" 2>/dev/null | wc -l || echo "0")
          echo "Total posts: $POST_COUNT" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ–¼ï¸ Check for large images
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ–¼ï¸ Large Images (>500KB)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          find public/assets -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" \) -size +500k 2>/dev/null | \
          while read -r img; do
            size=$(du -h "$img" | cut -f1)
            echo "- \`$img\` ($size)" >> $GITHUB_STEP_SUMMARY
          done || echo "None found âœ…" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # Deploy to GitHub Pages
  # ===========================================
  deploy:
    name: Deploy to GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    steps:
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: âœ… Deployment complete
        run: |
          echo "ğŸ‰ Successfully deployed to GitHub Pages!"
          echo "ğŸŒ URL: ${{ steps.deployment.outputs.page_url }}"

  # ===========================================
  # Post-Deploy Lighthouse (Live Site)
  # ===========================================
  lighthouse-live:
    name: Lighthouse (Live Site)
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    steps:
      - name: â³ Wait for deployment
        run: sleep 30

      - name: ğŸ”¦ Run Lighthouse on live site
        uses: treosh/lighthouse-ci-action@v11
        with:
          urls: |
            https://ramadangiving.github.io/
            https://ramadangiving.github.io/donate/
            https://ramadangiving.github.io/blog/
          uploadArtifacts: true
          temporaryPublicStorage: true
        continue-on-error: true

      - name: ğŸ“¤ Upload reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-live-reports
          path: '.lighthouseci'
          retention-days: 30
